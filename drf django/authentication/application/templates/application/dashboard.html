<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 100vh;
            background: linear-gradient(180deg, #212529, #343a40);
            color: white;
            padding-top: 1.5rem;
            position: sticky;
            top: 0;
        }

        .sidebar h5 {
            font-weight: 600;
            letter-spacing: .5px;
        }

        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: .375rem;
            margin-bottom: .5rem;
            transition: 0.3s;
            font-weight: 500;
        }

        .sidebar a.active, .sidebar a:hover {
            background: #0d6efd;
            color: #fff;
            transform: translateX(5px);
        }

        .content {
            padding: 2rem;
        }

        .card {
            border: none;
            border-radius: 12px;
        }

        #profileImage {
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            letter-spacing: 1px;
        }

        textarea {
            resize: none;
        }

        .post-card img {
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <span class="navbar-brand">üöÄ My Dashboard</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">Logout</button>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <h5 class="text-center text-white mb-4">üìå Menu</h5>
            <a href="#" class="active" id="homeTab">üè† Home</a>
            <a href="#" id="postsTab">üìù Posts</a>
            <a href="#" id="profileTab">üë§ Profile</a>
            <a href="#" id="settingsTab">‚öôÔ∏è Settings</a>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 content">

            <!-- Home -->
            <div class="card shadow-sm p-4 mb-4" id="homeSection">
                <h4>üéâ Welcome Back!</h4>
                <p id="welcomeMsg" class="text-muted"></p>
                <div id="postsList"></div>

                <!-- Empty state -->
                <div id="emptyPosts" class="text-center text-muted d-none">
                    <p>You have not created a post</p>
                    <p>üöÄ Create your first post!</p>
                    <button class="btn btn-success" onclick="showPostForm()">+ Create Post</button>
                </div>
            </div>

            <!-- Posts -->
            <div class="card shadow-sm p-4 mb-4 d-none" id="postsSection">
                <h4>üìù Create Posts</h4>
                <hr>
                <form id="postForm" enctype="multipart/form-data" class="mb-4">
                    <input type="hidden" id="postId">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="postTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="postDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image</label>
                        <input type="file" class="form-control" id="postImage" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary" id="postBtn">Create Post</button>
                </form>
            </div>

            <!-- Profile -->
            <div class="card shadow-sm p-4 mb-4 d-none" id="profileSection">
                <h4>üë§ User Profile</h4>
                <hr>
                <div class="text-center mb-3">
                    <img id="profileImage" src="" alt="Profile Picture" class="rounded-circle" width="130" height="130">
                    <h5 class="mt-3" id="profileUsername"></h5>
                    <p class="text-muted" id="profileEmail"></p>
                </div>
                <p><b>Bio:</b> <span id="profileBio"></span></p>
            </div>

            <!-- Settings -->
            <div class="card shadow-sm p-4 mb-4 d-none" id="settingsSection">
                <h4>‚öôÔ∏è Account Settings</h4>
                <hr>
                <form id="settingsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Profile Picture</label>
                        <input type="file" class="form-control" id="imageInput" accept="image/*">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="removeImageCheckbox">
                        <label class="form-check-label" for="removeImageCheckbox">Remove Profile Picture</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Username</label><input type="text"
                                                                                                    class="form-control"
                                                                                                    id="usernameInput">
                        </div>
                        <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email"
                                                                                                 class="form-control"
                                                                                                 id="emailInput"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Bio</label><textarea class="form-control" id="bioInput"
                                                                                     rows="3"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">New Password</label><input type="password"
                                                                                                        class="form-control"
                                                                                                        id="passwordInput">
                        </div>
                        <div class="col-md-6 mb-3"><label class="form-label">Confirm Password</label><input
                                type="password" class="form-control" id="confirmPasswordInput"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-outline-danger" id="deleteAccountBtn">Delete Account
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    const accessToken = localStorage.getItem("access");
    const refreshToken = localStorage.getItem("refresh");
    if (!accessToken) window.location.href = "/login/";
    let userId = null;

    // Fetch user data
    async function fetchUserData() {
        const res = await fetch("/me/", { headers: { "Authorization": "Bearer " + accessToken } });
        if(res.ok){
            const user = await res.json();
            userId = user.id;
            document.getElementById("welcomeMsg").innerText = "Hello, " + user.username;
            document.getElementById("profileUsername").innerText = user.username;
            document.getElementById("profileEmail").innerText = user.email;
            document.getElementById("profileBio").innerText = user.bio || "No bio added yet.";
            document.getElementById("profileImage").src = user.display_picture || "/media/profile/default.png";
            document.getElementById("usernameInput").value = user.username;
            document.getElementById("emailInput").value = user.email;
            document.getElementById("bioInput").value = user.bio || "";
        } else {
            alert("‚ö†Ô∏è Session expired!"); window.location.href="/login/";
        }
        fetchPosts();
    }
    fetchUserData();

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async()=> {
        await fetch("/api/token/logout/", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({refresh:refreshToken}) });
        localStorage.removeItem("access"); localStorage.removeItem("refresh"); window.location.href="/login/";
    });

    // Tabs
    ["homeTab","postsTab","profileTab","settingsTab"].forEach(tab=> {
        document.getElementById(tab).addEventListener("click", ()=> { showSection(tab.replace("Tab","Section"), tab); });
    });
    function showSection(sectionId, tabId){
        ["homeSection","postsSection","profileSection","settingsSection"].forEach(id=> document.getElementById(id).classList.add("d-none"));
        document.getElementById(sectionId).classList.remove("d-none");
        ["homeTab","postsTab","profileTab","settingsTab"].forEach(id=> document.getElementById(id).classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
    }

    // Delete Account
    document.getElementById("deleteAccountBtn").addEventListener("click", async()=> {
        if(!confirm("‚ö†Ô∏è Are you sure?")) return;
        const res = await fetch(`/users/${userId}/`, { method:"DELETE", headers:{ "Authorization": "Bearer "+accessToken } });
        if(res.ok||res.status===204){ alert("üóëÔ∏è Deleted!"); localStorage.removeItem("access"); localStorage.removeItem("refresh"); window.location.href="/signup/"; }
        else alert("‚ùå Error deleting account!");
    });

    // Posts CRUD
    async function fetchPosts(){
        const res = await fetch("/posts/", { headers:{ "Authorization": "Bearer "+accessToken } });
        if(res.ok){
            const posts = await res.json();
            const list = document.getElementById("postsList");
            const empty = document.getElementById("emptyPosts");

            list.innerHTML = "";
            if(posts.length === 0){
                empty.classList.remove("d-none");
                list.classList.add("d-none");
            } else {
                empty.classList.add("d-none");
                list.classList.remove("d-none");
                posts.forEach(post=>{
                    list.innerHTML += `<div class="card shadow-sm mb-3 post-card p-3">
                        <h5>${post.title}</h5>
                        <p>${post.description}</p>
                        ${post.image ? `<img src="${post.image}" alt="Post Image">` : ""}
                        <small class="text-muted">by ${post.user} on ${new Date(post.created_at).toLocaleString()}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-warning me-2" onclick="editPost(${post.id}, '${post.title.replace(/'/g,"\\'")}', '${post.description.replace(/'/g,"\\'")}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePost(${post.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>`;
                });
            }
        }
    }

    // Create or Update Post
    document.getElementById("postForm").addEventListener("submit", async e=>{
        e.preventDefault();
        const fd = new FormData();
        fd.append("title", document.getElementById("postTitle").value);
        fd.append("description", document.getElementById("postDescription").value);
        const img = document.getElementById("postImage").files[0];
        if(img) fd.append("image", img);

        const postId = document.getElementById("postId").value;
        let url = "/posts/", method="POST";
        if(postId){ url = `/posts/${postId}/`; method="PUT"; }

        const res = await fetch(url, { method, headers:{ "Authorization":"Bearer "+accessToken }, body: fd });
        if(res.ok){
            alert(postId ? "‚úÖ Post updated!" : "‚úÖ Post created!");
            document.getElementById("postForm").reset();
            document.getElementById("postId").value = "";
            document.getElementById("postBtn").innerText = "Create Post";
            fetchPosts();
        } else {
            alert("‚ùå Error: "+JSON.stringify(await res.json()));
        }
    });

    // Edit Post
    function editPost(id, title, description){
        document.getElementById("postId").value = id;
        document.getElementById("postTitle").value = title;
        document.getElementById("postDescription").value = description;
        document.getElementById("postBtn").innerText = "Update Post";
        showSection("postsSection", "postsTab");
    }

    // Delete Post
    async function deletePost(id){
        if(!confirm("‚ö†Ô∏è Delete this post?")) return;
        const res = await fetch(`/posts/${id}/`, { method:"DELETE", headers:{ "Authorization":"Bearer "+accessToken } });
        if(res.ok){ alert("üóëÔ∏è Post deleted!"); fetchPosts(); }
        else alert("‚ùå Error deleting post!");
    }

    // Show post form when no post
    function showPostForm(){
        showSection("postsSection", "postsTab");
        document.getElementById("postTitle").focus();
    }

    // Update Settings
    document.getElementById("settingsForm").addEventListener("submit", async e=>{
        e.preventDefault();

        const fd = new FormData();
        fd.append("username", document.getElementById("usernameInput").value);
        fd.append("email", document.getElementById("emailInput").value);
        fd.append("bio", document.getElementById("bioInput").value);

        const img = document.getElementById("imageInput").files[0];
        const remove = document.getElementById("removeImageCheckbox").checked;

        if(remove){
            fd.append("display_picture", "");
        } else if(img){
            fd.append("display_picture", img);
        }

        const pass = document.getElementById("passwordInput").value;
        const confirmPass = document.getElementById("confirmPasswordInput").value;
        if(pass && pass === confirmPass){
            fd.append("password", pass);
        }

        const res = await fetch(`/users/${userId}/`, {
            method: "PUT",
            headers: { "Authorization": "Bearer " + accessToken },
            body: fd
        });

        if(res.ok){
            alert("‚úÖ Profile updated!");
            fetchUserData();
        } else {
            alert("‚ùå Error: " + JSON.stringify(await res.json()));
        }
    });
</script>

</body>
</html>
